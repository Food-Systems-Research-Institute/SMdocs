{
  "hash": "f128b54e11a19475351c5084341ec7be",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Metric Trends\"\nformat:\n  html:\n    fig-dpi: 200\n    code-fold: true\neditor_options: \n  chunk_output_type: console\nwarnings: false\nexecute:\n  cache: false\n---\n\n\n\n\n::: {.callout-note collapse='false' title='Caution'}\nThis is a mildly slapdash page working out spatial regressions for time series metrics from the reifned framework variables. There are some cleaning issues to address with some variables, and the scripts are wildly disorganized. \n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\noptions(scipen = 999)\n\npacman::p_load(\n  dplyr,\n  htmltools,\n  stringr,\n  tidyr,\n  reactable,\n  # glmnet,\n  # missRanger,\n  purrr,\n  broom,\n  caret,\n  knitr,\n  tictoc,\n  furrr,\n  parallelly,\n  splm,\n  spdep,\n  sf\n)\n\n\n# Functions\nsource('dev/data_pipeline_functions.R')\nsource('dev/get_reactable.R')\nsource('dev/filter_fips.R')\n\nconflicts_prefer(\n  dplyr::select(),\n  dplyr::filter(),\n  dplyr::pull(),\n  stats::lag(),\n  .quiet = TRUE\n)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load metrics\nsm_data <- readRDS('data/sm_data.rds')\nmetrics <- sm_data$metrics\nmeta <- sm_data$metadata\n\n# Load frame\nframe <- readRDS('data/frameworks/new_frame.rds')\n```\n:::\n\n\n\n\nThis page explores what data we have available at the county level specifically. It is branching off of the main \"Analysis\" pages because they are state-level analyses and I want to leave it there for posterity.\n\nNote that there are some cleaning issues with this dataset, and the scripts are wildly disorganized. The important thing is that we figured out how to iterate through a few dozen variables and run spatial error models at the county level to see if they are getting better or worse over time.\n\n## Explore Metrics and Resolution\n\nCheck how many metrics we have:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvars <- frame %>% \n  filter(variable_name != 'NONE') %>% \n  pull(variable_name)\ncount <- length(vars)\n```\n:::\n\n\n\n\nWe have 124 metrics overall\n\nCheck which metrics are available at state vs county levels.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_str(metrics)\n\n# Filter to vars, remove state fips codes\nvar_metrics <- metrics %>%\n  filter(\n    variable_name %in% vars\n  )\nget_str(var_metrics)\nlength(unique(var_metrics$variable_name))\n\n# Check how many are left\nout <- var_metrics %>% \n  filter(str_length(fips) == 5) %>% \n  pull(variable_name) %>% \n  unique() %>% \n  length()\nout\nperc_county <- out / length(unique(var_metrics$variable_name))\n# 73 (58%) are at the county level. Better\n```\n:::\n\n\n\n\n73 (58.9%) are available at county level.\n\nMake a table to explore what we have at each level:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## What do we ONLY have at the state level?\ncounty_metrics <- var_metrics %>% \n  filter(str_length(fips) == 5) %>% \n  pull(variable_name) %>%\n  unique()\nstate_metrics <- var_metrics %>% \n  filter(str_length(fips) == 2) %>% \n  pull(variable_name) %>%\n  unique()\n(state_only <- setdiff(state_metrics, county_metrics))\nlength(state_only)\n\n# Back to frame for context\nstate_only_frame <- frame %>% \n  filter(variable_name %in% state_only)\nstate_only_frame\n\n\n## Get the ones that are available at county level\nget_str(frame)\ncounty_df <- frame %>% \n  filter(\n    !variable_name %in% state_only_frame$variable_name,\n    variable_name != 'NONE'\n  )\nget_str(county_df)\n\n# Save just the county level variables here for analyses\ncounty_vars <- county_df$variable_name\n\n# We actually want a DF with a column that specifies the difference\ndf <- frame %>% \n  filter(variable_name != 'NONE') %>% \n  mutate(has_county = case_when(\n    variable_name %in% county_df$variable_name ~ TRUE,\n    .default = FALSE\n  ))\nget_str(df)\n\n# Save this somewhere for some reason\nwrite.csv(df, 'data/frontiers/metric_resolution.csv')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nget_reactable(df, defaultPageSize = 5)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"reactable html-widget html-fill-item\" id=\"htmlwidget-ecafd68cdda5438c5ed8\" style=\"width:auto;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-ecafd68cdda5438c5ed8\">{\"x\":{\"tag\":{\"name\":\"Reactable\",\"attribs\":{\"data\":{\"dimension\":[\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"economics\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"environment\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"health\",\"production\",\"production\",\"production\",\"production\",\"production\",\"production\",\"production\",\"production\",\"production\",\"production\",\"production\",\"production\",\"production\",\"production\",\"production\",\"production\",\"production\",\"production\",\"social\",\"social\",\"social\",\"social\",\"social\",\"social\",\"social\",\"social\",\"social\",\"social\"],\"index\":[\"access to capital/credit\",\"access to capital/credit\",\"access to capital/credit\",\"access to capital/credit\",\"access to capital/credit\",\"access to capital/credit\",\"access to capital/credit\",\"community economy\",\"community economy\",\"community economy\",\"community economy\",\"community economy\",\"community economy\",\"community economy\",\"community economy\",\"community economy\",\"community economy\",\"food business resilience\",\"food business resilience\",\"food business resilience\",\"food business resilience\",\"food business resilience\",\"food business resilience\",\"food business resilience\",\"food business resilience\",\"food business resilience\",\"food business resilience\",\"carbon, ghg, nutrients\",\"carbon, ghg, nutrients\",\"carbon, ghg, nutrients\",\"carbon, ghg, nutrients\",\"carbon, ghg, nutrients\",\"carbon, ghg, nutrients\",\"carbon, ghg, nutrients\",\"carbon, ghg, nutrients\",\"carbon, ghg, nutrients\",\"carbon, ghg, nutrients\",\"carbon, ghg, nutrients\",\"forest\",\"forest\",\"forest\",\"forest\",\"forest\",\"species and habitat\",\"species and habitat\",\"species and habitat\",\"species and habitat\",\"species and habitat\",\"species and habitat\",\"species and habitat\",\"species and habitat\",\"species and habitat\",\"species and habitat\",\"species and habitat\",\"water\",\"water\",\"water\",\"water\",\"water\",\"water\",\"water\",\"water\",\"water\",\"food security\",\"food security\",\"food security\",\"food security\",\"food security\",\"food security\",\"food security\",\"food security\",\"food security\",\"food security\",\"food security\",\"food security\",\"food security\",\"food security\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"physical health\",\"imports vs exports\",\"imports vs exports\",\"production diversity\",\"production margins\",\"production margins\",\"production margins\",\"production margins\",\"production margins\",\"production margins\",\"production margins\",\"production margins\",\"waste and losses\",\"waste and losses\",\"waste and losses\",\"waste and losses\",\"waste and losses\",\"waste and losses\",\"waste and losses\",\"community embeddedness\",\"community embeddedness\",\"community embeddedness\",\"community livability\",\"community livability\",\"community livability\",\"food and farmworker diversity\",\"food and farmworker diversity\",\"food and farmworker diversity\",\"food system governance\"],\"indicator\":[\"access to land\",\"access to land\",\"access to land\",\"access to land\",\"access to land\",\"access to land\",\"access to land\",\"wealth/income distribution\",\"wealth/income distribution\",\"wealth/income distribution\",\"wealth/income distribution\",\"wealth/income distribution\",\"wealth/income distribution\",\"wealth/income distribution\",\"wealth/income distribution\",\"wealth/income distribution\",\"wealth/income distribution\",\"income stability\",\"income stability\",\"income stability\",\"labor costs\",\"labor costs\",\"labor costs\",\"operations diversification\",\"operations diversification\",\"operations diversification\",\"use of ag/farm/crop insurance\",\"carbon fluxes\",\"carbon fluxes\",\"carbon fluxes\",\"carbon fluxes\",\"carbon stocks\",\"carbon stocks\",\"carbon stocks\",\"embodied carbon\",\"embodied carbon\",\"embodied carbon\",\"embodied carbon\",\"forest health\",\"forest health\",\"forest health\",\"forest health\",\"forest health\",\"biodiversity\",\"biodiversity\",\"biodiversity\",\"biodiversity\",\"biodiversity\",\"biodiversity\",\"biodiversity\",\"biodiversity\",\"land use diversity\",\"sensitive or rare habitats\",\"sensitive or rare habitats\",\"water quality\",\"water quality\",\"water quality\",\"water quality\",\"water quality\",\"water quality\",\"water quantity\",\"water quantity\",\"water quantity\",\"access to culturally appropriate food\",\"dietary quality\",\"dietary quality\",\"dietary quality\",\"food access\",\"food access\",\"food access\",\"food access\",\"food affordability\",\"food affordability\",\"food affordability\",\"food affordability\",\"food affordability\",\"food affordability\",\"access to care\",\"access to care\",\"access to care\",\"housing supply and quality\",\"housing supply and quality\",\"housing supply and quality\",\"housing supply and quality\",\"housing supply and quality\",\"physical health tbd\",\"physical health tbd\",\"physical health tbd\",\"physical health tbd\",\"physical health tbd\",\"physical health tbd\",\"physical health tbd\",\"physical health tbd\",\"physical health tbd\",\"physical health tbd\",\"physical health tbd\",\"total quantity exported\",\"total quantity imported\",\"production species diversity\",\"production inputs\",\"total quantity food products\",\"total quantity food products\",\"total quantity forest products\",\"total quantity non-food ag products\",\"total quantity non-food ag products\",\"value added market\",\"value added market\",\"crop failure\",\"crop failure\",\"crop failure\",\"crop failure\",\"crop failure\",\"crop failure\",\"crop failure\",\"social connectedness\",\"social connectedness\",\"social connectedness\",\"community safety\",\"diverse representation\",\"diverse representation\",\"age diversity\",\"gender diversity\",\"racial diversity\",\"participatory governance\"],\"metric\":[\"Mean acres per farm\",\"Median acres per farm\",\"Land and building value per acre\",\"Land and building value per farm\",\"Capital expenditures, buildings and land, exc...\",\"Capital consumption, all, excl. operator dwel...\",\"Interest expenses, real estate, excl. operato...\",\"Median earnings (dollars) for female, farming...\",\"Median earnings (dollars) for female, food pr...\",\"Median earnings (dollars) for male, farming, ...\",\"Median earnings (dollars) for male, food prep...\",\"Women's earnings as a percentage of men's ear...\",\"Women's earnings as a percentage of men's ear...\",\"Gender pay gap\",\"Income inequality\",\"Gini Index\",\"Unemployment Rate\",\"Net return to operators\",\"Labor expenses as percentage of expenses\",\"mean farm related income per operation\",\"Number of migrant workers\",\"Number of short-term workers\",\"Number of unpaid workers\",\"Farms, direct-to-consumer sales as a percent ...\",\"Agritourism, sales as a percent of all farm s...\",\"Farms, local marketing channel sales as a per...\",\"Proportion of area (by county) affected by FS...\",\"Total CH4 emissions from agriculture (Tg)\",\"Total CO2 emissions from agriculture (Tg)\",\"Total N2O emissions from agriculture (Tg)\",\"Air pollution - particulate matter\",\"Forest carbon - dead and down\",\"Forest carbon - live standing\",\"Forest carbon - standing dead\",\"Operations using geoexchange\",\"Operations with methane digesters\",\"Operations with solar power\",\"Operations with wind power\",\"Dead trees per forested acre\",\"Forest canopy cover\",\"Forest live tree volume per acre\",\"Forest stand height\",\"Live trees per forested acre\",\"Percentage of animal species at risk\",\"Percentage of bee species at risk\",\"Percentage of orchid species at risk\",\"Percentage of plant species at risk\",\"Total number of animal species\",\"Total number of bee species\",\"Total number of orchid species\",\"Total number of plant species\",\"Land Use Diversity\",\"Percentage of ecosystems at risk\",\"Total number of ecosystems\",\"Lake habitat complexity condition class\",\"Riparian vegetation condition class\",\"Riparian vegetation condition, based on L_XCM...\",\"Site condition class based on conductivity\",\"Site condition class based on total nitrogen ...\",\"Site condition class based on total phosphoru...\",\"Expenses from water for irrigation sourced of...\",\"Total expenses from water for irrigation sour...\",\"Mean percent area in drought\",\"SFAs serving culturally relevant food\",\"SFAs percentage of spending on local food\",\"SFAs serving local food\",\"SFAs with Farm to School program\",\"Community Supported Agriculture (CSA), number...\",\"Farmers markets, number of businesses\",\"Grocery stores/1,000 pop\",\"Limited access to healthy foods\",\"SNAP participation rates, all eligible people\",\"SNAP-authorized stores/1,000 pop\",\"Specialized food stores/1,000 pop\",\"WIC coverage rate\",\"WIC eligibility rate\",\"WIC-authorized stores/1,000 pop\",\"Child care centers\",\"Child care cost burden\",\"Uninsured\",\"Homeownership\",\"Severe housing cost burden\",\"Severe housing problems\",\"Median rent as a percentage of income\",\"Rental vacancy rate\",\"Drinking water violations\",\"Adult obesity\",\"Adult smoking\",\"Diabetes prevalence\",\"Drug overdose deaths\",\"Excessive drinking\",\"Infant mortality\",\"Life expectancy\",\"Low birthweight\",\"Motor vehicle crash deaths\",\"Premature age-adjusted mortality\",\"Value of total agricultural exports\",\"value of top five imports\",\"Crop diversity\",\"Mean chemical expenses per operation\",\"Total animal sales\",\"Total crop sales\",\"Total forest product income\",\"Cash receipts value, forest products , all\",\"Value of production, services and forestry, a...\",\"Farms, percent of all farms with value-added ...\",\"Farms, value-added sales as a percent of all ...\",\"Other farm income, insurance indemnities\",\"Other farm income, insurance indemnities, fed...\",\"Value of ad hoc and emergency program payment...\",\"Value of agricultural risk coverage payments,...\",\"Value of all other ad hoc and emergency progr...\",\"Value of dairy margin protection program paym...\",\"Value of price loss coverage payments, all\",\"Children in single-parent households\",\"Disconnected youth\",\"Social associations\",\"Alcohol-impaired driving deaths\",\"Residential segregation - black/white\",\"School segregation\",\"Mean producer age\",\"Ratio of female to male producers\",\"Racial diversity of producers\",\"Voter turnout\"],\"variable_name\":[\"acresPF\",\"medianAcresPF\",\"landValPerAcre\",\"landValPF\",\"totalCapExpBldgsLandNoDwellings\",\"totalCapConsNoDwellings\",\"totalIntExpRealEstateNoDwellings\",\"medianFemaleEarningsFFF\",\"medianFemaleEarningsFPS\",\"medianMaleEarningsFFF\",\"medianMaleEarningsFPS\",\"womenEarnPercMenFFF\",\"womenEarnPercMenFPS\",\"genderPayGap\",\"incomeInequality\",\"gini\",\"unemploymentRate\",\"netReturnOperators\",\"expHiredLaborPercOpExp\",\"farmIncomePF\",\"nMigrantWorkers\",\"nWorkersLE150\",\"nUnpaidWorkers\",\"d2cSalesPerc\",\"agTourSalesPerc\",\"localSalesPerc\",\"propAreaFsaSecDisasters\",\"CH4FromAg\",\"CO2FromAg\",\"N2OFromAg\",\"airPollutionParticulateMatter\",\"forestCarbonDeadDown\",\"forestCarbonLive\",\"forestCarbonDeadStanding\",\"geoexchangeNOps\",\"methaneNOps\",\"solarNOps\",\"windTurbinesNOps\",\"forestDeadTrees\",\"forestCanopyCover\",\"forestLiveTreeVolume\",\"forestStandHeight\",\"forestLiveTrees\",\"pctAtRiskAnimalSpp\",\"pctAtRiskBeeSpp\",\"pctAtRiskOrchidSpp\",\"pctAtRiskPlantSpp\",\"sppAnimals\",\"sppBees\",\"sppOrchids\",\"sppPlants\",\"lulcDiversity\",\"pctAtRiskEcosystems\",\"nEcosystems\",\"lakesLitripcvrCond\",\"lakesRvegCond\",\"riversRipvegCond\",\"riversSalCond\",\"riversNtlCond\",\"riversPtlCond\",\"waterIrrSrcOffFarmExpPerAcreFt\",\"waterIrrSrcOffFarmExp\",\"droughtMeanPercArea\",\"sfaCulturallyRelevant\",\"sfaLocalFoodCosts\",\"sfaServeLocal\",\"sfaFarmToSchool\",\"nCSA\",\"nFarmersMarket\",\"nGrocPTH\",\"limitedAccessToHealthyFoods\",\"snapPercPart\",\"nSnapGrocPTH\",\"nSpecGrocPTH\",\"wicPercPart\",\"wicPercEligible\",\"nWicsGrocPTH\",\"childCareCenters\",\"childCareCostBurden\",\"uninsured\",\"homeownership\",\"severeHousingCostBurden\",\"severeHousingProblems\",\"rentMedianPercHH\",\"vacancyRate\",\"drinkingWaterViolations\",\"adultObesity\",\"adultSmoking\",\"diabetesPrevalence\",\"drugOverdoseDeaths\",\"excessiveDrinking\",\"infantMortality\",\"lifeExpectancy\",\"lowBirthweight\",\"motorVehicleCrashDeaths\",\"prematureAgeAdjustedMortality\",\"exportsTotalAgricultural\",\"importsTopFive\",\"cropDiversity\",\"expChemicalPct\",\"salesAnimal\",\"salesCrop\",\"incForestProducts\",\"totalReceiptsAllForestProducts\",\"totalValueServicesAndForestry\",\"valueAddedFarmsPerc\",\"valueAddedSalesPerc\",\"totalIncomeInsuranceIndemnities\",\"totalIncomeInsuranceIndemnitiesFederal\",\"totalValueEmergPayments\",\"totalValueAgRiskCoveragePayments\",\"totalValueOtherAdHocEmergPayments\",\"totalValueDairyMarginProtPayments\",\"totalValueAllLossCoveragePayments\",\"childrenInSingleParentHouseholds\",\"disconnectedYouth\",\"socialAssociations\",\"alcoholImpairedDrivingDeaths\",\"residentialSegregationBlackWhite\",\"schoolSegregation\",\"ageProducers\",\"ftmProdRatio\",\"producerRacialDiversity\",\"voterTurnout\"],\"has_county\":[true,true,true,true,false,false,false,true,true,true,true,true,true,true,true,true,true,false,true,true,true,true,true,true,true,true,false,false,false,false,true,true,true,true,false,false,false,false,true,true,true,true,true,false,false,false,false,false,false,false,false,true,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,true,true,true,true,false,true,true,false,false,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,true,false,false,true,false,true,true,true,false,false,true,true,false,false,false,false,false,false,false,true,true,true,true,true,true,true,true,false,true]},\"columns\":[{\"id\":\"dimension\",\"name\":\"dimension\",\"type\":\"character\"},{\"id\":\"index\",\"name\":\"index\",\"type\":\"character\"},{\"id\":\"indicator\",\"name\":\"indicator\",\"type\":\"character\"},{\"id\":\"metric\",\"name\":\"metric\",\"type\":\"character\"},{\"id\":\"variable_name\",\"name\":\"variable_name\",\"type\":\"character\"},{\"id\":\"has_county\",\"name\":\"has_county\",\"type\":\"logical\"}],\"resizable\":true,\"filterable\":true,\"searchable\":true,\"defaultPageSize\":5,\"showPageSizeOptions\":true,\"onClick\":\"select\",\"highlight\":true,\"bordered\":true,\"striped\":true,\"compact\":true,\"style\":{\"fontSize\":\"14px\"},\"dataKey\":\"1b9db47b713873e817c938f177da2720\"},\"children\":[]},\"class\":\"reactR_markup\"},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n\n## Explore Trends\n\nTake the county variables we currently have, take the ones that have > 1 year represented, and get a preliminary on if they are changing over time, and if so, in which direction.\n\nFirst get out county level data frame in long format:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\noutcome_vars <- c(\n  'foodInsecurity',\n  'communityEnvRank',\n  'happinessScore',\n  'wellbeingRank',\n  'workEnvRank',\n  'foodEnvironmentIndex',\n  'lifeExpectancy',\n  'population',\n  'gdpCurrent'\n)\n\n# Get actual metrics data that at county level only\ncounty_metrics <- metrics %>% \n  filter(\n    variable_name %in% c(county_vars, outcome_vars),\n    str_length(fips) == 5,\n    variable_name != 'unemploymentRate'\n  )\n\n# get_str(county_metrics)\nkable(head(county_metrics))\n```\n:::\n\n\n\n\nThis is our county level metric dataset in long format.\n\nNow prep time series by filter to metrics with > 1 data point. While we're at it, get a sense of what periodicity looks like. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Using county metrics data but with all years\nget_str(county_metrics)\nunique(county_metrics$variable_name)\nlength(unique(county_metrics$variable_name))\n\n# Get names of vars that have > 1 time point\nseries_vars <- county_metrics %>% \n  group_by(variable_name) %>% \n  summarize(n_year = length(unique(year))) %>% \n  filter(n_year > 1) %>% \n  pull(variable_name)\nlen <- length(series_vars)\n# 64 have more than 1 time point. That's actually not bad\n\n# Filter to just those variables so we can do regressions\nseries_metrics <- filter(metrics, variable_name %in% series_vars)\nget_str(series_metrics)\n\n# Side note - what is frequency of years\ntab <- series_metrics %>% \n  group_by(variable_name) %>% \n  mutate(year = as.numeric(year)) %>% \n  summarize(years = list(unique(year))) %>% \n  mutate(diffs = map_dbl(as.vector(years), ~ {\n    unique(diff(sort(.x)))\n  })) %>% \n  pull(diffs) %>% \n  get_table()\ntab\nprop_tab <- prop.table(tab)\n```\n:::\n\n\n\n\n64 metrics have > 1 data point at county level. 0.640625% are annual and 0.359375% are every 5 years.\n\nLet's do some linear regressions to what trends look like. Note that I think we should do spatial regressions for the real thing (and ideally also Bayesian if we can work out Gaussian processes), but this is what the FSCI did in their 2025 update so it should be enough I suppose.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nres <- map(series_vars, ~ {\n  tryCatch(\n    {\n      df <- series_metrics %>% \n        filter(variable_name == .x) %>% \n        mutate(\n          value = as.numeric(value),\n          year = as.numeric(year)\n        )\n      model <- lm(value ~ year, data = df)\n    },\n    error = function(e) {\n      message(paste('Error with var', .x))\n    }\n  )\n}) %>% \n  setNames(c(series_vars)) %>% \n  discard(\\(x) is.null(x))\n```\n:::\n\n\n\n\nNow that we have regression outputs, let's put them in a table to see which ones were significant. \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Put together one table of results from all models, add stars\nres_df <- imap(res, ~ {\n  .x %>% \n    tidy() %>% \n    filter(term == 'year') %>% \n    mutate(term = .y)\n}) %>% \n  bind_rows() %>% \n  mutate(sig = ifelse(p.value < 0.05, '*', ''))\nres_df\n\n# How many metrics\nn_metrics <- nrow(res_df)\n\n# How many are significant\nperc_sig <- mean(res_df$sig == '*') * 100\n```\n:::\n\n\n\n\nWe have 64 metrics, 39.1 of which vary significantly over time.\n\nStill have to make sense of the directional values of our metrics. These were defined in the [Aggregation](../pages/aggregation.qmd) from the main analysis branch.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Of those that are significant, what are trends\n# leaving in all of them, even if not significant though\nmodel_outputs <- res_df %>% \n  # filter(sig == '*') %>%\n  mutate(trend = case_when(\n    estimate > 0 & sig == '*' ~ 'increasing',\n    sig == '' ~ NA_character_,\n    .default = 'decreasing'\n  ))\n\n# Bring in directional values. If not reverse, then positive is good\nreverse <- readRDS('data/helpers/metrics_value_reversed.rds')\n\n# Some of our reversed vars were missing from that analysis. Add them in here\nreverse <- c(\n  reverse, \n  'adultObesity',\n  'adultSmoking',\n  'excessiveDrinking',\n  'foodInsecurity',\n  'genderPayGap',\n  'rentMedianPerc'\n)\n\n# And some new ones to remove\nremove <- c(\n  'nMigrantWorkers',\n  'nUnpaidWorkers',\n  'population',\n  'vacancyRate',\n  'expHiredLaborPercOpExp'\n)\n\n\n# Filter out the removes (should really do this earlier in script though)\nget_str(model_outputs)\nmodel_outputs <- model_outputs %>% \n  filter(!term %in% remove)\nget_str(model_outputs)\n\n\n# Check what we have, see what we are covering\ncheck_vars <- data.frame(var = series_vars) %>% \n  mutate(reverse = ifelse(var %in% reverse, TRUE, FALSE)) %>% \n  filter(!var %in% remove)\ncheck_vars  \n\n\n# save an object for refined outputs to use alter\nrefined_vars <- model_outputs$term\n\n# Add them to outputs\nmodel_outputs <- model_outputs %>% \n  mutate(\n    reverse = ifelse(term %in% reverse, TRUE, FALSE),\n    outcome = case_when(\n      reverse == FALSE & trend == 'increasing' ~ 'better',\n      reverse == FALSE & trend == 'decreasing' ~ 'worse',\n      reverse == TRUE & trend == 'increasing' ~ 'worse',\n      reverse == TRUE & trend == 'decreasing' ~ 'better',\n      .default = NA\n    ),\n    across(where(is.numeric), ~ format(round(.x, 3), nsmall = 3))\n  )\nmodel_outputs\n\n# proportion getting better or worse\n(tab <- table(model_outputs$outcome))\npercs <- prop.table(tab) * 100\n```\n:::\n\n\n\n\n48% are getting better and 52% are getting worse.\n\nCheck out table with outputs for each regression. Filter by significance and outcome. Trend is just whether it is going up or down, outcome is whether that is good or bad.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_reactable(\n  model_outputs, \n  defaultPageSize = 10,\n  columns = list(\n   term = colDef(minWidth = 200),\n   sig = colDef(minWidth = 50),\n   reverse = colDef(minWidth = 75),\n   statistic = colDef(minWidth = 75),\n   outcome = colDef(minWidth = 75)\n  )\n)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"reactable html-widget html-fill-item\" id=\"htmlwidget-eac5815ed69f3a90f00e\" style=\"width:auto;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-eac5815ed69f3a90f00e\">{\"x\":{\"tag\":{\"name\":\"Reactable\",\"attribs\":{\"data\":{\"term\":[\"acresPF\",\"adultObesity\",\"adultSmoking\",\"agTourSalesPerc\",\"ageProducers\",\"airPollutionParticulateMatter\",\"alcoholImpairedDrivingDeaths\",\"childCareCenters\",\"childCareCostBurden\",\"childrenInSingleParentHouseholds\",\"cropDiversity\",\"d2cSalesPerc\",\"diabetesPrevalence\",\"disconnectedYouth\",\"drinkingWaterViolations\",\"drugOverdoseDeaths\",\"excessiveDrinking\",\"farmIncomePF\",\"foodEnvironmentIndex\",\"foodInsecurity\",\"ftmProdRatio\",\"genderPayGap\",\"gini\",\"homeownership\",\"incForestProducts\",\"incomeInequality\",\"infantMortality\",\"landValPF\",\"landValPerAcre\",\"lifeExpectancy\",\"limitedAccessToHealthyFoods\",\"localSalesPerc\",\"lowBirthweight\",\"medianAcresPF\",\"medianFemaleEarningsFFF\",\"medianFemaleEarningsFPS\",\"medianMaleEarningsFFF\",\"medianMaleEarningsFPS\",\"motorVehicleCrashDeaths\",\"nGrocPTH\",\"nSnapGrocPTH\",\"nSpecGrocPTH\",\"nWicsGrocPTH\",\"nWorkersLE150\",\"prematureAgeAdjustedMortality\",\"rentMedianPercHH\",\"residentialSegregationBlackWhite\",\"salesAnimal\",\"salesCrop\",\"schoolSegregation\",\"severeHousingCostBurden\",\"severeHousingProblems\",\"socialAssociations\",\"uninsured\",\"valueAddedFarmsPerc\",\"valueAddedSalesPerc\",\"voterTurnout\",\"womenEarnPercMenFFF\",\"womenEarnPercMenFPS\"],\"estimate\":[\"       0.471\",\"       0.007\",\"      -0.002\",\"       0.001\",\"       0.203\",\"      -0.286\",\"       0.001\",\"       0.181\",\"       0.028\",\"      -0.019\",\"      -0.008\",\"      -0.003\",\"      -0.004\",\"       0.001\",\"      -0.026\",\"       1.511\",\"      -0.002\",\"     849.074\",\"       0.031\",\"      -0.005\",\"       0.001\",\"       0.004\",\"       0.002\",\"       0.003\",\"  339026.074\",\"      -0.004\",\"      -0.054\",\"   29962.531\",\"     176.272\",\"      -0.243\",\"       0.000\",\"       0.002\",\"       0.001\",\"      -0.774\",\"-2429343.811\",\" -803317.215\",\"-2863354.644\",\"-1267197.880\",\"       0.055\",\"      -0.008\",\"      -0.002\",\"      -0.004\",\"      -0.008\",\"    -357.150\",\"       8.362\",\"      -0.137\",\"       0.642\",\"52149758.143\",\"64860291.334\",\"      -0.004\",\"      -0.002\",\"      -0.003\",\"      -0.122\",\"      -0.001\",\"       0.001\",\"      -0.001\",\"       0.000\",\"   16930.628\",\"      -0.645\"],\"std.error\":[\"       3.611\",\"       0.001\",\"       0.001\",\"       0.001\",\"       0.052\",\"       0.043\",\"       0.002\",\"       0.382\",\"       0.004\",\"       0.002\",\"       0.003\",\"       0.003\",\"       0.000\",\"       0.001\",\"       0.012\",\"       0.299\",\"       0.001\",\"     135.663\",\"       0.030\",\"       0.001\",\"       0.004\",\"       0.004\",\"       0.000\",\"       0.002\",\"  132171.623\",\"       0.016\",\"       0.045\",\"    4707.154\",\"     129.356\",\"       0.052\",\"       0.001\",\"       0.004\",\"       0.000\",\"       0.582\",\" 4120724.140\",\"  434346.906\",\" 1926757.618\",\" 1102122.476\",\"       0.128\",\"       0.003\",\"       0.007\",\"       0.003\",\"       0.003\",\"     248.611\",\"       1.923\",\"       0.025\",\"       0.289\",\"29918617.541\",\"36903728.930\",\"       0.006\",\"       0.001\",\"       0.001\",\"       0.096\",\"       0.001\",\"       0.001\",\"       0.002\",\"       0.010\",\"   14802.337\",\"       0.285\"],\"statistic\":[\"  0.131\",\"  6.272\",\" -2.517\",\"  1.072\",\"  3.890\",\" -6.605\",\"  0.293\",\"  0.474\",\"  6.652\",\"-11.159\",\" -2.646\",\" -1.342\",\" -7.608\",\"  1.857\",\" -2.202\",\"  5.051\",\" -2.980\",\"  6.259\",\"  1.035\",\" -7.347\",\"  0.352\",\"  1.024\",\"  8.759\",\"  1.671\",\"  2.565\",\" -0.256\",\" -1.207\",\"  6.365\",\"  1.363\",\" -4.662\",\"  0.067\",\"  0.564\",\"  1.486\",\" -1.330\",\" -0.590\",\" -1.849\",\" -1.486\",\" -1.150\",\"  0.430\",\" -2.295\",\" -0.283\",\" -1.165\",\" -3.024\",\" -1.437\",\"  4.348\",\" -5.425\",\"  2.223\",\"  1.743\",\"  1.758\",\" -0.596\",\" -2.120\",\" -3.998\",\" -1.273\",\" -1.337\",\"  0.509\",\" -0.609\",\"  0.000\",\"  1.144\",\" -2.259\"],\"p.value\":[\"0.896\",\"0.000\",\"0.012\",\"0.285\",\"0.000\",\"0.000\",\"0.770\",\"0.636\",\"0.000\",\"0.000\",\"0.008\",\"0.181\",\"0.000\",\"0.064\",\"0.028\",\"0.000\",\"0.003\",\"0.000\",\"0.301\",\"0.000\",\"0.725\",\"0.306\",\"0.000\",\"0.095\",\"0.011\",\"0.798\",\"0.228\",\"0.000\",\"0.174\",\"0.000\",\"0.947\",\"0.574\",\"0.138\",\"0.184\",\"0.556\",\"0.065\",\"0.138\",\"0.251\",\"0.667\",\"0.023\",\"0.777\",\"0.246\",\"0.003\",\"0.152\",\"0.000\",\"0.000\",\"0.027\",\"0.082\",\"0.080\",\"0.551\",\"0.034\",\"0.000\",\"0.204\",\"0.182\",\"0.611\",\"0.543\",\"1.000\",\"0.253\",\"0.024\"],\"sig\":[\"\",\"*\",\"*\",\"\",\"*\",\"*\",\"\",\"\",\"*\",\"*\",\"*\",\"\",\"*\",\"\",\"*\",\"*\",\"*\",\"*\",\"\",\"*\",\"\",\"\",\"*\",\"\",\"*\",\"\",\"\",\"*\",\"\",\"*\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"*\",\"\",\"\",\"*\",\"\",\"*\",\"*\",\"*\",\"\",\"\",\"\",\"*\",\"*\",\"\",\"\",\"\",\"\",\"\",\"\",\"*\"],\"trend\":[null,\"increasing\",\"decreasing\",null,\"increasing\",\"decreasing\",null,null,\"increasing\",\"decreasing\",\"decreasing\",null,\"decreasing\",null,\"decreasing\",\"increasing\",\"decreasing\",\"increasing\",null,\"decreasing\",null,null,\"increasing\",null,\"increasing\",null,null,\"increasing\",null,\"decreasing\",null,null,null,null,null,null,null,null,null,\"decreasing\",null,null,\"decreasing\",null,\"increasing\",\"decreasing\",\"increasing\",null,null,null,\"decreasing\",\"decreasing\",null,null,null,null,null,null,\"decreasing\"],\"reverse\":[false,true,true,false,true,true,true,false,true,true,false,false,true,true,true,true,true,false,false,true,false,true,true,false,false,true,true,false,false,false,true,false,true,false,false,false,false,false,true,false,false,false,false,false,true,false,true,false,false,true,true,true,false,true,false,false,false,false,false],\"outcome\":[null,\"worse\",\"better\",null,\"worse\",\"better\",null,null,\"worse\",\"better\",\"worse\",null,\"better\",null,\"better\",\"worse\",\"better\",\"better\",null,\"better\",null,null,\"worse\",null,\"better\",null,null,\"better\",null,\"worse\",null,null,null,null,null,null,null,null,null,\"worse\",null,null,\"worse\",null,\"worse\",\"worse\",\"worse\",null,null,null,\"better\",\"better\",null,null,null,null,null,null,\"worse\"]},\"columns\":[{\"id\":\"term\",\"name\":\"term\",\"type\":\"character\",\"minWidth\":200},{\"id\":\"estimate\",\"name\":\"estimate\",\"type\":\"character\"},{\"id\":\"std.error\",\"name\":\"std.error\",\"type\":\"character\"},{\"id\":\"statistic\",\"name\":\"statistic\",\"type\":\"character\",\"minWidth\":75},{\"id\":\"p.value\",\"name\":\"p.value\",\"type\":\"character\"},{\"id\":\"sig\",\"name\":\"sig\",\"type\":\"character\",\"minWidth\":50},{\"id\":\"trend\",\"name\":\"trend\",\"type\":\"character\"},{\"id\":\"reverse\",\"name\":\"reverse\",\"type\":\"logical\",\"minWidth\":75},{\"id\":\"outcome\",\"name\":\"outcome\",\"type\":\"character\",\"minWidth\":75}],\"resizable\":true,\"filterable\":true,\"searchable\":true,\"defaultPageSize\":10,\"showPageSizeOptions\":true,\"onClick\":\"select\",\"highlight\":true,\"bordered\":true,\"striped\":true,\"compact\":true,\"style\":{\"fontSize\":\"14px\"},\"dataKey\":\"574bffcde2ef1f2312567316595cb305\"},\"children\":[]},\"class\":\"reactR_markup\"},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n\n## Moran's Tests\n\n::: {.callout-note collapse='false' title='Caution'}\nTurns out this whole section is moot. Moran test and spatialreg packages can only do cross-sections. So just skip down to the Spatial Regressions section where we do it with spml instead.\n:::\n\nMoran's test for spatial autocorrelation, determines whether we need to run spatial regressions. Turns out this is a bit hinky with spotty data. Starting with a single run on a single year to see how it works:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_str(series_metrics)\nget_str(refined_vars)\n\n# get single metric\ndat <- series_metrics %>% \n  filter(\n    str_length(fips) == 5,\n    variable_name == 'gini'\n  ) %>% \n  pivot_wider(\n    id_cols = fips:year,\n    names_from = variable_name,\n    values_from = value\n  ) %>% \n  mutate(across(c(year, gini), as.numeric))\nget_str(dat)\n\n## Check how many counties are in each year\ndat %>% \n  group_by(year) %>% \n  summarize(count = n())\n# they switch in 2022. Let's just take up through 2021 to make this work for now \n# OLS model\n\n# Pull county polygons 2024\ncounties <- readRDS('data/sm_spatial.rds')[['ne_counties_2021']]\ncounties\n\n# Combine data with polygons in one file\ndat_sf <- dat %>% \n  filter(year < 2022) %>% \n  left_join(counties, by = 'fips')\nget_str(dat_sf)\n\n# Get neighbor list from counties\nnb <- poly2nb(counties)\nnb\nclass(nb)\nsummary(nb)\n\n\n## Check Moran's stat for each year?\nlw <- nb2listw(nb)\n\n# Moran test for each year\nyears <- sort(unique(dat_sf$year))\nresults <- map(years, ~ {\n  dat_sf %>% \n    filter(year == .x) %>% \n    pull(gini) %>% \n    moran.test(lw)\n})\nget_str(results[[1]])\nany(map_dbl(results, ~ .x$p.value) < 0.05)\n# No spatial autocorrelation here I guess?\n```\n:::\n\n\n\n\nLooks like it works, also looks like there is no spatial correlation within this variable in this year.\n\nTry running Moran test for each variable in each year systematically:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncounty_metrics <- series_metrics %>% \n  filter(\n    str_length(fips) == 5,\n    !variable_name %in% c('population')\n  )\nget_str(county_metrics)\n\n# Get wide(r) df of all metrics\ndat <- county_metrics %>% \n  pivot_wider(\n    id_cols = fips:year,\n    names_from = variable_name,\n    values_from = value\n  ) %>% \n  mutate(across(!fips, as.numeric))\nget_str(dat)\n\n# Check how many counties are in each year\ndat %>% \n  group_by(year) %>% \n  summarize(count = n())\n# 2022 has some old and some new CT counties! Sheesh\n\n# Let's pull 2021 counties, filter to only those in the data\ncounties <- readRDS('data/sm_spatial.rds')[['ne_counties_2021']]\ncounties\n\n# Combine county spatial files with data, which will also filter to old counties\ndat <- left_join(dat, counties) %>% \n  select(-aland, -awater)\nget_str(dat)\n\n\n## For each variable, for each year: run moran test\n(vars <- names(dat)[!names(dat) %in% c(\n  'fips', \n  'year', \n  'geometry', \n  'womenEarnPercMenFPS',\n  'expHiredLaborPercOpExp'\n)])\n\nget_time()\nplan(multisession, workers = availableCores(omit = 2))\nout <- future_map(vars, \\(var) {\n  \n  # Get unique years and fips for that var\n  pars <- dat %>% \n    select(fips, year, !!sym(var), geometry) %>% \n    na.omit() %>% \n    select(year, fips)\n  \n  # Single out unique years, we use fips later\n  years <- sort(unique(pars[['year']]))\n    \n  # For each year, get counties, lw, and moran test\n  year_results <- map(years, \\(yr) {\n    # Get fips in that year\n    fips_subset <- pars %>% \n      filter(year == yr) %>% \n      pull(fips)\n    \n    # Use fips to get county subset for that year\n    county_subset <- dat %>% \n      filter(\n        year == yr,\n        fips %in% fips_subset\n      ) %>% \n      st_as_sf() %>% \n      st_make_valid() %>% \n      filter(!st_is_empty(geometry))\n    \n    # Now we can get lw from counties that year\n    tryCatch({\n      lw <- nb2listw(poly2nb(county_subset))\n    }, error = function(e) {\n      print(e)\n      return(paste('Error in poly2nb:', e$message))\n    })\n    \n    # FINALLY get Moran test for that var in that year\n    # Catch errors because of missing values...\n    tryCatch({\n      test <- county_subset %>% \n        filter(year == yr) %>% \n        pull(!!sym(var)) %>% \n        moran.test(lw)\n    }, error = function(e) {\n      print(paste0('Error in ', var, ', year ', yr, e))\n      return(paste('Error in Moran:', e$message))\n    })\n  }) %>% \n    setNames(c(paste0('y', years)))\n}, .progress = TRUE) %>% \n  setNames(c(vars))\nplan(sequential)\n\nget_str(out)\n# saveRDS(out, 'data/objects/moran_outs.rds')\n```\n:::\n\n\n\n\nYeesh, that was hairy. Let's explore those results now:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nout <- readRDS('data/objects/moran_outs.rds')\nget_str(out)\nget_str(out[[1]])\n\n# Pull out stat and p value for each set of results\ndf_list <- map(out, \\(var) {\n  imap(var, \\(year, yr_string) {\n    if (class(year) == 'htest') {\n      data.frame(\n        'year' = yr_string,\n        'moran' = year$statistic,\n        'p' = year$p.value\n      )\n    } \n  }) %>% \n    bind_rows()\n}) %>% \n  imap_dfr(~ mutate(.x, var = .y))\nrownames(df_list) <- NULL\nget_str(df_list)\n\n# Make a nicer table, rounding off, remove the ys, remove rownames\ntab <- df_list %>% \n  mutate(\n    year = str_remove(year, 'y')\n  )\ntab  \n\n# Summary stats for each var\nsum <- tab %>% \n  group_by(var) %>% \n  summarize(prop_sig = mean(p < 0.05)) %>% \n  arrange(desc(prop_sig)) %>% \n  mutate(prop_sig = format(round(prop_sig, 3), nsmall = 3))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nget_reactable(sum)\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"reactable html-widget html-fill-item\" id=\"htmlwidget-9f93c8e63fa253dde38f\" style=\"width:auto;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-9f93c8e63fa253dde38f\">{\"x\":{\"tag\":{\"name\":\"Reactable\",\"attribs\":{\"data\":{\"var\":[\"acresPF\",\"adultObesity\",\"adultSmoking\",\"airPollutionParticulateMatter\",\"childCareCenters\",\"childCareCostBurden\",\"cropDiversity\",\"d2cSalesPerc\",\"diabetesPrevalence\",\"excessiveDrinking\",\"foodEnvironmentIndex\",\"foodInsecurity\",\"genderPayGap\",\"gini\",\"homeownership\",\"incomeInequality\",\"landValPF\",\"landValPerAcre\",\"lifeExpectancy\",\"limitedAccessToHealthyFoods\",\"localSalesPerc\",\"medianAcresPF\",\"motorVehicleCrashDeaths\",\"nGrocPTH\",\"nMigrantWorkers\",\"nSnapGrocPTH\",\"nSpecGrocPTH\",\"nUnpaidWorkers\",\"nWicsGrocPTH\",\"prematureAgeAdjustedMortality\",\"schoolSegregation\",\"severeHousingCostBurden\",\"severeHousingProblems\",\"uninsured\",\"vacancyRate\",\"valueAddedFarmsPerc\",\"voterTurnout\",\"residentialSegregationBlackWhite\",\"socialAssociations\",\"farmIncomePF\",\"incForestProducts\",\"nWorkersLE150\",\"salesAnimal\",\"salesCrop\",\"medianFemaleEarningsFPS\",\"medianMaleEarningsFPS\",\"drinkingWaterViolations\",\"drugOverdoseDeaths\",\"lowBirthweight\",\"ageProducers\",\"ftmProdRatio\",\"medianMaleEarningsFFF\",\"rentMedianPercHH\",\"medianFemaleEarningsFFF\",\"womenEarnPercMenFFF\",\"agTourSalesPerc\",\"alcoholImpairedDrivingDeaths\",\"childrenInSingleParentHouseholds\",\"disconnectedYouth\",\"valueAddedSalesPerc\"],\"prop_sig\":[\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"1.000\",\"0.800\",\"0.800\",\"0.750\",\"0.750\",\"0.750\",\"0.750\",\"0.750\",\"0.625\",\"0.625\",\"0.600\",\"0.600\",\"0.600\",\"0.500\",\"0.500\",\"0.375\",\"0.250\",\"0.125\",\"0.125\",\"0.000\",\"0.000\",\"0.000\",\"0.000\",\"0.000\"]},\"columns\":[{\"id\":\"var\",\"name\":\"var\",\"type\":\"character\"},{\"id\":\"prop_sig\",\"name\":\"prop_sig\",\"type\":\"character\"}],\"resizable\":true,\"filterable\":true,\"searchable\":true,\"defaultPageSize\":10,\"showPageSizeOptions\":true,\"onClick\":\"select\",\"highlight\":true,\"bordered\":true,\"striped\":true,\"compact\":true,\"style\":{\"fontSize\":\"14px\"},\"dataKey\":\"2627f8df740f95958e73f69ec52f9f43\"},\"children\":[]},\"class\":\"reactR_markup\"},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\nprop_sig is the proportion of years within that variable that are significantly spatially correlated. Looks like many variables are spatially autocorrelated, but not all. Wonder whether it's worth running spatial regressions on all of them, or only the variables (and years) that are significantly spatially correlated.\n\nProblems with Moran's test (and spatial regressions generally) right now:\n\n- County arrangements change between years. Newer variables might be on Connecticut's governance regions, giving us 68 counties in New England rather than 67. The switch happened in 2022, but not every metric reflects this shift at the same time! Isn't that fun\n- Still some issues with different object lengths between spatial list weights and datasets in the moran tests\n- Would probably be better off running Moran Monte Carlos instead of Moran tests, but that is going to up the run time substantially and I don't think it matters all that much here.\n\n## Spatial Panel Regressions\n\nRun spatial regression for all vars. Might be worth looking into whether there is a version of Moral test that can be run across years. Until then, just running each one with spatial error model. \n\n### Try it once\n\nTry splm on just one variable first:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_str(series_metrics)\n\ndat <- series_metrics %>% \n  filter(\n    variable_name != 'population',\n    str_length(fips) == 5\n  ) %>% \n  pivot_wider(\n    id_cols = fips:year,\n    names_from = variable_name,\n    values_from = value\n  )\n\n# Get rid of geometry, make our df a plm object\ndf <- dat %>% \n  select(fips, year, rentMedianPercHH) %>% \n  filter(str_detect(fips, '^09', negate = TRUE)) %>%\n  na.omit() %>% \n  mutate(rentMedianPercHH = as.numeric(rentMedianPercHH)) %>% \n  plm::pdata.frame()\nget_str(df)\n\n# Get our listw based on counties kept (not CT)\nlw <- counties %>% \n  filter(fips %in% df$fips) %>% \n  poly2nb() %>% \n  nb2listw(zero.policy = TRUE)\n\n# Try FE error model with rentMedianPercHH\nfe_err <- spml(\n  rentMedianPercHH ~ as.numeric(year), \n  data = df, \n  listw = lw,\n  model = 'within'\n)\nsummary(fe_err)\n\n# RE error model\nre_err <- spml(\n  rentMedianPercHH ~ as.numeric(year), \n  data = df, \n  listw = lw,\n  model = 'random'\n)\nsummary(re_err)\n\n# Check to use RE or FE, see whether x_it related to a_i (idiosyncratic error)\ntest <- sphtest(fe_err, re_err)\ntest\n# Not sig: use RE, more efficient\n\n# Check RE output\nsummary(re_err)\n```\n:::\n\n\n\n\n### Do it for all vars\n\nSo the workflow for each variable is:\n\n1. Make sure panel is balanced, i.e. see if Connecticut will be a problem. Adjust accordingly.\n2. Create list weight object based on the counties that are represented by in the variable. I think we have to do this for each variable individually... should double check though.\n3. Run FE and RE model with year as numeric.\n4. Hausman test with FE and RE model. If sig, report FE, if not, report RE\n\nTry it:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nget_str(dat)\n\n# Make variables numeric\ndat <- dat %>% \n  mutate(across(3:last_col(), as.numeric))\nget_str(dat)\n\n# Get vector of vars\nvars <- names(dat)[!names(dat) %in% c('fips', 'year')]\n\n# Map over each var and do steps 1 through 5\nplan(multisession, cores = availableCores(omit = 2))\nout <- future_map(vars, \\(var) {\n  \n  cat('\\n\\nStarting', var)\n  \n  tryCatch({\n    # Reduce to relevant variable, remove NAs\n    df <- dat %>% \n      select(fips, year, !!sym(var)) %>% \n      drop_na()\n    \n    # 1. Only use fips that produce balanced panel\n    balanced_fips <- df %>% \n      group_by(fips) %>% \n      filter(n() == length(unique(df$year))) %>% \n      pull(fips) %>% \n      unique()\n    \n    df <- df %>% \n      filter(fips %in% balanced_fips)\n    \n    # 2. Create lw object\n    lw <- counties %>% \n      filter(fips %in% balanced_fips) %>% \n      # filter(fips %in% df$fips) %>% \n      poly2nb() %>% \n      nb2listw(zero.policy = TRUE)\n    cat('\\nCreated lw')\n    \n    # Make df a plm object\n    df <- plm::pdata.frame(df)\n    \n    # 3. Run FE and RE\n    formula <- as.formula(paste(var, \"~ as.numeric(year)\"))\n    fe <- spml(\n      formula,\n      data = df, \n      listw = lw,\n      model = 'within'\n    )\n    re <- spml(\n      formula,\n      data = df, \n      listw = lw,\n      model = 'random'\n    )\n    cat('\\nRan models')\n    \n    # 4. Hausman test. If sig, use FE\n    test <- sphtest(fe, re)\n    if (test$p.value < 0.05) {\n      model <- fe\n    } else {\n      model <- re\n    }\n    cat('\\nRan Hausman')\n    \n    return(list('model' = model, 'fips' = balanced_fips))\n      \n    },\n    error = function(e) {\n      return(paste0('Error with ', var, ': ', e))\n    }\n  )\n  \n}, .progress = FALSE) %>% \n setNames(c(vars))\nplan(sequential)\n\n# Save for posterity\nsaveRDS(out, 'data/objects/spatial_regression_outs.rds')\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nout <- readRDS('data/objects/spatial_regression_outs.rds')\n\n# How many were successful\nperc_success <- mean(map(out, class) == 'list') * 100\n\nget_str(out[[1]])\nget_str(out)\nout\n\n# Check out errors only\nerrors <- out %>% \n  keep(is.character)\nerrors\nerror_vars <- names(errors)\n```\n:::\n\n\n\n\n\n92.1% of regressions were successful. The last few were some fucked up metrics for one reason or another. They include: infantMortality\\, disconnectedYouth\\, voterTurnout\\, expHiredLaborPercOpExp\\, salesCrop.\n\nCheck out the successful models:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmodel_outs <- out %>% \n  keep(is.list)\n# get_str(model_outs)\n# get_str(model_outs[[1]])\n# get_str(model_outs[[1]][[1]])\n\n# Check model type\n# model_outs[[1]][[1]]$type\n# table(map_chr(model_outs, ~ .x[[1]]$type))\n# They are all RE models - no FE\n\n\n## Test out outcomes\n# sum <- summary(model_outs[[1]][[1]])\n# coefs <- sum$CoefTable[2, ]\n\n# Make a table\nspatial_table <- imap(model_outs, ~ {\n  tryCatch({\n    \n    # Pull model output results and coefficients\n    sum <- summary(.x[[1]])\n    coefs <- sum$CoefTable[2, ]\n    \n    df <- data.frame(\n      n = length(.x$fips),\n      type = .x[[1]]$type,\n      var = .y,\n      phi = sum$errcomp[1],\n      rho = sum$errcomp[2],\n      est = coefs[1],\n      se = coefs[2],\n      t = coefs[3],\n      p = coefs[4]\n    ) \n    \n    # Figure out good or bad outcome\n    # If sig, then check reverse. else blank\n    # If reverse, reverse it, else same\n    # If up, good, else bad\n    df <- df %>% \n      mutate(\n        sig = ifelse(p < 0.05, TRUE, FALSE),\n        posneg = case_when(\n          est > 0 ~ 'pos',\n          est < 0 ~ 'neg',\n          .default = ''\n        ),\n        reverse = ifelse(.y %in% reverse, TRUE, FALSE),\n        direction = case_when(\n          sig == TRUE & reverse == TRUE & posneg == 'pos' ~ 'neg',\n          sig == TRUE & reverse == TRUE & posneg == 'neg' ~ 'pos',\n          sig == TRUE & reverse == FALSE ~ as.character(posneg),\n          .default = ''\n        ),\n        outcome = case_when(\n          sig == FALSE ~ '',\n          sig == TRUE & direction == 'pos' ~ 'better',\n          sig == TRUE & direction == 'neg' ~ 'worse',\n          .default = '-'\n        )\n      ) %>% \n      select(-c(posneg, direction))\n    return(df)\n  },\n    error = function(e) {\n      return(paste('Error:', e))\n    }\n  )\n}) %>% \n  bind_rows()\n# get_str(spatial_table)\n\n# Round off and make table\nspatial_table %>% \n  mutate(\n    across(c(phi:p), ~ format(round(.x, 3), nsmall = 3)),\n    type = case_when(\n      str_detect(type, 'random') ~ 'RE',\n      .default = NA\n    )\n  ) %>% \n  get_reactable(\n    defaultColDef = colDef(minWidth = 50),\n    columns = list(\n      n = colDef(minWidth = 25),\n      var = colDef(minWidth = 200),\n      est = colDef(\n        minWidth = 100,\n        name = ''\n      ),\n      outcome = colDef(minWidth = 75),\n      rho = colDef(name = ''),\n      phi = colDef(name = ''),\n      p = colDef(name = 'p-value'),\n      'p-value' = colDef(minWidth = 100)\n    )\n  )\n```\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"reactable html-widget html-fill-item\" id=\"htmlwidget-bbe3180dc27d17425305\" style=\"width:auto;height:auto;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-bbe3180dc27d17425305\">{\"x\":{\"tag\":{\"name\":\"Reactable\",\"attribs\":{\"data\":{\"n\":[59,59,59,59,59,59,59,59,59,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,67,63,51,64,67,67,65,67,67,67,66,46,65,53,58,67,67,67,67,67,62,39,65,60,64,67,67,67,52,55,67,67],\"type\":[\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\",\"RE\"],\"var\":[\"rentMedianPercHH\",\"medianFemaleEarningsFFF\",\"medianMaleEarningsFFF\",\"medianFemaleEarningsFPS\",\"medianMaleEarningsFPS\",\"vacancyRate\",\"womenEarnPercMenFFF\",\"womenEarnPercMenFPS\",\"gini\",\"lowBirthweight\",\"adultSmoking\",\"adultObesity\",\"foodEnvironmentIndex\",\"excessiveDrinking\",\"alcoholImpairedDrivingDeaths\",\"uninsured\",\"incomeInequality\",\"childrenInSingleParentHouseholds\",\"socialAssociations\",\"airPollutionParticulateMatter\",\"drinkingWaterViolations\",\"severeHousingProblems\",\"lifeExpectancy\",\"prematureAgeAdjustedMortality\",\"diabetesPrevalence\",\"foodInsecurity\",\"limitedAccessToHealthyFoods\",\"drugOverdoseDeaths\",\"residentialSegregationBlackWhite\",\"motorVehicleCrashDeaths\",\"homeownership\",\"severeHousingCostBurden\",\"schoolSegregation\",\"genderPayGap\",\"childCareCostBurden\",\"childCareCenters\",\"valueAddedFarmsPerc\",\"agTourSalesPerc\",\"d2cSalesPerc\",\"valueAddedSalesPerc\",\"localSalesPerc\",\"nGrocPTH\",\"nSpecGrocPTH\",\"nSnapGrocPTH\",\"nWicsGrocPTH\",\"cropDiversity\",\"nWorkersLE150\",\"nMigrantWorkers\",\"nUnpaidWorkers\",\"farmIncomePF\",\"acresPF\",\"medianAcresPF\",\"landValPF\",\"landValPerAcre\",\"salesAnimal\",\"incForestProducts\",\"ageProducers\",\"ftmProdRatio\"],\"phi\":[\"  1.097\",\"  1.499\",\"  1.520\",\"  0.164\",\"  1.874\",\"179.534\",\"  1.400\",\"  0.175\",\"  4.790\",\"  7.824\",\"  6.303\",\"  5.007\",\"  6.907\",\"  0.646\",\"  1.849\",\" 13.516\",\" 14.713\",\"  2.516\",\" 22.456\",\"  1.741\",\"  0.672\",\" 12.207\",\" 17.238\",\" 19.403\",\"  1.194\",\"  9.790\",\"  6.562\",\"  4.882\",\"  3.480\",\" 34.647\",\" 69.895\",\"  9.757\",\"121.507\",\"  6.574\",\"  1.561\",\" 28.758\",\"  0.726\",\"  0.613\",\"  1.959\",\"  0.213\",\"  1.865\",\"  7.263\",\"  6.750\",\" 19.070\",\"  4.099\",\"  5.798\",\"  4.343\",\"  2.602\",\" 10.737\",\"  0.937\",\" 16.247\",\" 11.453\",\"  2.248\",\"  1.340\",\" 24.959\",\"  0.871\",\"  1.539\",\"  2.517\"],\"rho\":[\" 0.225\",\"-0.029\",\" 0.007\",\"-0.027\",\"-0.024\",\" 0.264\",\"-0.055\",\" 0.080\",\"-0.139\",\" 0.015\",\" 0.700\",\" 0.029\",\" 0.257\",\" 0.597\",\"-0.108\",\" 0.299\",\"-0.093\",\" 0.650\",\" 0.027\",\" 0.430\",\" 0.223\",\"-0.039\",\" 0.268\",\" 0.209\",\" 0.284\",\" 0.303\",\"-0.038\",\"-0.003\",\"-0.031\",\" 0.028\",\" 0.027\",\" 0.033\",\"-0.136\",\" 0.042\",\" 0.015\",\"-0.303\",\" 0.044\",\"-0.159\",\"-0.125\",\"-0.108\",\" 0.274\",\" 0.065\",\" 0.056\",\" 0.266\",\"-0.291\",\" 0.283\",\" 0.129\",\"-0.034\",\"-0.008\",\"-0.084\",\"-0.049\",\" 0.167\",\" 0.259\",\"-0.045\",\" 0.058\",\" 0.112\",\"-0.066\",\"-0.593\"],\"est\":[\"       -0.158\",\"-10686026.438\",\" -3085551.687\",\" -1620650.416\",\" -2569510.000\",\"       -0.116\",\"    14060.244\",\"       -1.007\",\"        0.002\",\"        0.000\",\"        0.001\",\"        0.006\",\"        0.042\",\"       -0.004\",\"        0.003\",\"       -0.002\",\"        0.002\",\"       -0.022\",\"       -0.149\",\"       -0.275\",\"       -0.040\",\"       -0.004\",\"       -0.162\",\"        5.734\",\"       -0.005\",\"       -0.004\",\"        0.000\",\"        1.523\",\"        0.882\",\"       -0.001\",\"        0.004\",\"       -0.002\",\"       -0.003\",\"        0.006\",\"        0.037\",\"        0.095\",\"        0.003\",\"        0.005\",\"       -0.032\",\"       -0.017\",\"        0.010\",\"       -0.005\",\"        0.001\",\"       -0.012\",\"       -0.022\",\"       -0.009\",\"      -48.975\",\"       -0.893\",\"      -97.833\",\"     4061.226\",\"        0.896\",\"       -2.940\",\"    58007.146\",\"     1037.207\",\"  1003325.666\",\"   131170.209\",\"        1.233\",\"        0.009\"],\"se\":[\"      0.032\",\"4093527.453\",\"1971536.640\",\" 781752.300\",\"1261296.303\",\"      0.031\",\"  15367.468\",\"      0.549\",\"      0.000\",\"      0.000\",\"      0.001\",\"      0.001\",\"      0.009\",\"      0.001\",\"      0.002\",\"      0.000\",\"      0.005\",\"      0.003\",\"      0.024\",\"      0.046\",\"      0.019\",\"      0.000\",\"      0.020\",\"      0.591\",\"      0.000\",\"      0.000\",\"      0.000\",\"      0.146\",\"      0.206\",\"      0.029\",\"      0.000\",\"      0.000\",\"      0.000\",\"      0.002\",\"      0.004\",\"      0.077\",\"      0.006\",\"      0.005\",\"      0.010\",\"      0.011\",\"      0.021\",\"      0.008\",\"      0.008\",\"      0.016\",\"      0.005\",\"      0.001\",\"     13.770\",\"     10.555\",\"      8.778\",\"    714.441\",\"      0.990\",\"      0.637\",\"  11714.630\",\"    681.740\",\" 420860.191\",\"  27205.853\",\"      0.242\",\"      0.008\"],\"t\":[\" -4.995\",\" -2.610\",\" -1.565\",\" -2.073\",\" -2.037\",\" -3.727\",\"  0.915\",\" -1.833\",\" 19.150\",\"  4.215\",\"  0.504\",\"  9.578\",\"  4.701\",\" -2.420\",\"  1.644\",\" -5.727\",\"  0.319\",\" -6.891\",\" -6.102\",\" -6.008\",\" -2.179\",\"-15.228\",\" -8.236\",\"  9.703\",\"-10.284\",\"-10.844\",\" -0.580\",\" 10.403\",\"  4.273\",\" -0.047\",\" 11.013\",\" -6.705\",\" -6.670\",\"  2.283\",\"  9.898\",\"  1.236\",\"  0.586\",\"  0.911\",\" -3.262\",\" -1.566\",\"  0.466\",\" -0.634\",\"  0.110\",\" -0.725\",\" -4.080\",\" -6.157\",\" -3.557\",\" -0.085\",\"-11.146\",\"  5.684\",\"  0.906\",\" -4.615\",\"  4.952\",\"  1.521\",\"  2.384\",\"  4.821\",\"  5.093\",\"  1.109\"],\"p\":[\"0.000\",\"0.009\",\"0.118\",\"0.038\",\"0.042\",\"0.000\",\"0.360\",\"0.067\",\"0.000\",\"0.000\",\"0.615\",\"0.000\",\"0.000\",\"0.016\",\"0.100\",\"0.000\",\"0.750\",\"0.000\",\"0.000\",\"0.000\",\"0.029\",\"0.000\",\"0.000\",\"0.000\",\"0.000\",\"0.000\",\"0.562\",\"0.000\",\"0.000\",\"0.962\",\"0.000\",\"0.000\",\"0.000\",\"0.022\",\"0.000\",\"0.216\",\"0.558\",\"0.362\",\"0.001\",\"0.117\",\"0.641\",\"0.526\",\"0.912\",\"0.468\",\"0.000\",\"0.000\",\"0.000\",\"0.933\",\"0.000\",\"0.000\",\"0.365\",\"0.000\",\"0.000\",\"0.128\",\"0.017\",\"0.000\",\"0.000\",\"0.267\"],\"sig\":[true,true,false,true,true,true,false,false,true,true,false,true,true,true,false,true,false,true,true,true,true,true,true,true,true,true,false,true,true,false,true,true,true,true,true,false,false,false,true,false,false,false,false,false,true,true,true,false,true,true,false,true,true,false,true,true,true,false],\"reverse\":[false,false,false,false,false,false,false,false,true,true,true,true,false,true,true,true,true,true,false,true,true,true,false,true,true,true,true,true,true,true,false,true,true,true,true,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,true,false],\"outcome\":[\"worse\",\"worse\",\"\",\"worse\",\"worse\",\"worse\",\"\",\"\",\"worse\",\"worse\",\"\",\"worse\",\"better\",\"better\",\"\",\"better\",\"\",\"better\",\"worse\",\"better\",\"better\",\"better\",\"worse\",\"worse\",\"better\",\"better\",\"\",\"worse\",\"worse\",\"\",\"better\",\"better\",\"better\",\"worse\",\"worse\",\"\",\"\",\"\",\"worse\",\"\",\"\",\"\",\"\",\"\",\"worse\",\"worse\",\"worse\",\"\",\"worse\",\"better\",\"\",\"worse\",\"better\",\"\",\"better\",\"better\",\"worse\",\"\"]},\"columns\":[{\"id\":\"n\",\"name\":\"n\",\"type\":\"numeric\",\"minWidth\":25},{\"id\":\"type\",\"name\":\"type\",\"type\":\"character\",\"minWidth\":50},{\"id\":\"var\",\"name\":\"var\",\"type\":\"character\",\"minWidth\":200},{\"id\":\"phi\",\"name\":\"\",\"type\":\"character\",\"minWidth\":50},{\"id\":\"rho\",\"name\":\"\",\"type\":\"character\",\"minWidth\":50},{\"id\":\"est\",\"name\":\"\",\"type\":\"character\",\"minWidth\":100},{\"id\":\"se\",\"name\":\"se\",\"type\":\"character\",\"minWidth\":50},{\"id\":\"t\",\"name\":\"t\",\"type\":\"character\",\"minWidth\":50},{\"id\":\"p\",\"name\":\"p-value\",\"type\":\"character\",\"minWidth\":50},{\"id\":\"sig\",\"name\":\"sig\",\"type\":\"logical\",\"minWidth\":50},{\"id\":\"reverse\",\"name\":\"reverse\",\"type\":\"logical\",\"minWidth\":50},{\"id\":\"outcome\",\"name\":\"outcome\",\"type\":\"character\",\"minWidth\":75}],\"resizable\":true,\"filterable\":true,\"searchable\":true,\"defaultPageSize\":10,\"showPageSizeOptions\":true,\"onClick\":\"select\",\"highlight\":true,\"bordered\":true,\"striped\":true,\"compact\":true,\"style\":{\"fontSize\":\"14px\"},\"dataKey\":\"29797387c9a0dea44444bff5b519ed28\"},\"children\":[]},\"class\":\"reactR_markup\"},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n- n: Number of counties included in regression\n- type: FE = fixed effects (every county has $\\beta$), RE = random effects (counties have different $\\beta$s)\n- var: Metric\n- $\\phi$: Spatial autocorrelation in idiosyncratic attributes (counties)\n- $\\rho$: Spatial autocorrelation in residual errors (omitted variables)\n- $\\beta$: Regression coefficient of year on the variable\n- se: standard error of $\\beta$\n- t: test statistic\n- p-value: p-value\n- sig: whether p is < 0.05\n- reverse: whether the metric has been reversed so that lower numbers are better and higher numbers are worse (like food insecurity)\n- outcome: if the regression is significant, is it getting better or worse? Accounts for the 'reverse' variable\n\n\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/core-js-2.5.3/shim.min.js\"></script>\n<script src=\"../site_libs/react-18.2.0/react.min.js\"></script>\n<script src=\"../site_libs/react-18.2.0/react-dom.min.js\"></script>\n<script src=\"../site_libs/reactwidget-2.0.0/react-tools.js\"></script>\n<link href=\"../site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<link href=\"../site_libs/reactable-0.4.4/reactable.css\" rel=\"stylesheet\" />\n<script src=\"../site_libs/reactable-binding-0.4.4/reactable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}